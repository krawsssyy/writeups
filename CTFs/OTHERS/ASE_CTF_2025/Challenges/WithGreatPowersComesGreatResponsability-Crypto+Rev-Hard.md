# Building

Identify a vulnerable RSA modulus generation algorithm and break the given values to decrypt the flag. The binary is in Go and is obfuscated with Garble.

```go.mod
module chall

go 1.22
```

Update go if necessary
```bash
cd /tmp
wget https://go.dev/dl/go1.25.3.linux-amd64.tar.gz
rm -rf /usr/local/go
tar -C /usr/local -xzf go1.25.3.linux-amd64.tar.gz
export PATH=/usr/local/go/bin:$PATH
go version
```
Install garble and build
```bash
go install mvdan.cc/garble@latest
export PATH="$(go env GOPATH)/bin:$PATH"
garble -literals -tiny -seed=random build \
  -trimpath -buildvcs=false -ldflags "-s -w -buildid=" -o chall .
```

If no garble, then for building we do
```bash
go build -trimpath -buildvcs=false -ldflags "-s -w -buildid=" -o chall .
strip -s chall
```

# Challenge code - main.go

```Go
package main

import (
    "bufio"
    crand "crypto/rand"
    "fmt"
    "log"
    "math/big"
    "os"
    "strings"
)

func powBig(a *big.Int, e int) *big.Int {
    if e < 0 {
        panic("negative exponent")
    }
    res := new(big.Int).SetInt64(1)
    base := new(big.Int).Set(a)
    n := e
    for n > 0 {
        if n & 1 == 1 {
            res.Mul(res, base)
        }
        n >>= 1
        if n > 0 {
            base.Mul(base, base)
        }
    }
    return res
}

func readFlag() []byte {
    f, err := os.Open("flag.txt")
    if err != nil {
        log.Fatalf("failed to open flag.txt: %v", err)
    }
    defer f.Close()
    data, err := bufio.NewReader(f).ReadBytes('\n')
    if err == nil {
        return []byte(strings.TrimRight(string(data), "\r\n"))
    }
    f2, err2 := os.ReadFile("flag.txt")
    if err2 != nil {
        log.Fatalf("failed to read flag.txt: %v", err2)
    }
    return f2
}

func gen128() *big.Int {
    x, err := crand.Int(crand.Reader, new(big.Int).Lsh(big.NewInt(1), 128))
    if err != nil { 
        log.Fatalf("rand: %v", err) 
    }
    x.SetBit(x, 127, 1)
    return x
}

func randInt(lo int64, hi int64) int64 {
    if hi < lo { 
        panic("bad range") 
    }
    span := big.NewInt(hi - lo + 1)
    n, err := crand.Int(crand.Reader, span)
    if err != nil { 
        log.Fatalf("rand: %v", err) 
    }
    return new(big.Int).Add(n, big.NewInt(lo)).Int64()
}

func main() {
    e := big.NewInt(65537)
    m := 1 << uint(4)
    flag := readFlag()
    mInt := new(big.Int).SetBytes(flag)
    var p, q, ra, rb *big.Int
    for {
        a := gen128()
        b := gen128()
        if a.Cmp(b) == 0 { 
            continue 
        }
        ra = big.NewInt(randInt(1010, 1015))
        rb = big.NewInt(randInt(1315, 1320))

        pCand := powBig(a, m)
        pCand.Add(pCand, ra)
        if !pCand.ProbablyPrime(64) { 
            continue 
        }

        qCand := powBig(b, m)
        qCand.Add(qCand, rb)
        if !qCand.ProbablyPrime(64) { 
            continue 
        }

        p, q = pCand, qCand
        break
    }

    N := new(big.Int).Mul(p, q)
    if mInt.Cmp(N) >= 0 {
        log.Fatalf("flag interpreted as integer must be < N")
    }

    c := new(big.Int).Exp(mInt, e, N)

    fmt.Println("N=", N.String())
    fmt.Println("c=", c.String())
}
```

# Solution script - solver.sage

Algorithm found in this article - [http://psasir.upm.edu.my/id/eprint/76375/1/8.pdf].

```Python
from sage.all import *

N = ZZ(681394780999866190754659213123044717191715802643250708626809320838658778281144593727739663209837045355995308421413942828514152818648977873331104105081516452731800472325836611779314818462243193426099023496541746425007897604260151865971382334573678159185236454545626597908840746093045971828762474777264361457955742301124914308817172222724904673662370155602109259829569214773320574391778663341473530817577757208567569217179499401601819814059135668317316486810860796513686364156076445602008131732866040545046905275113589058718772631135615671995571949598884279533991843760477188394490194661695211918956119252397613791660662786638355440627365801169939573638066199940297947011255546242278159925314216283426330130357017097669042049401560818361006121158551800594245771687561997457507996473064827678925407234466681829883216945008610190906166966671484929431907603318173185118690723356055852743648251196391861556170411865924607659462219924254880433507916185443528766788839916434005473516259899808211380528891901570026087255071960852088469607478882639920289227459708783304155068215963885816028437091388019124889893940103059466112671620816380233612284989568840512084173935363114174196347989885994578950712852340332187131129751064242447872289)
e = ZZ(65537)
c = ZZ(42812930977524388513467562381107665457183388179636833486233298730856495507811454372446817014742478391753520100955900662459440703250225912163667412234230775948596810879200171037918862486053895636221232174786574190495217421100347415667882255496851995994695491088407437761854050557569735344397955049370600967236505786065690814196706045553475040729490360627571218433857809780258536268867273856941268352549971044327276794642397894590386970406674745468703436828305366428115493442636651259651285006514360923051001535102411311724083832635270403587675731040211836579605525772366137880862174700376474667107710764260252619650415358916289186247552886970262957279613209341156545305894050225570647662268359552920453354322430337770926296883749970372606744758064847265556586272075949309988217520649401232406289505004905379321221026461011286211685830451863238237168823938290390724239244714746192656154662454445221786726747276537045701380922973056489425141619977400519472770363724019322774287259895354759692851921617742024273320139201682823625006695203900063086423792385111412451649160021208097073639113907258231413500099172566638471762083423570648556289456872193692404267834356235516359256634399940815612978430415246658154399380930510570722036)

def factor_via_algorithm(N, ra, rb, m):
    i = Integer(ceil(sqrt(ra * rb)))
    limit = Integer(floor(rb / 2 + 2 ** (m / 2 - 1) * ra + 1))
    
    while i < limit:
        sigma = Integer((floor(sqrt(N)) - i) ** 2)
        z = (N - ra * rb) % sigma
        disc = z * z - 4 * sigma * ra * rb
        if disc >= 0:
            if disc.is_square():
                x_1 = (z + sqrt(disc)) / 2
                x_2 = (z - sqrt(disc)) / 2
                test_1 = (x_1 / rb + ra)
                test_2 = (x_2 / ra + rb)
                if N % test_1 or N % test_2:
                    i += 1
                    continue
                else:
                    return test_1, test_2
            else:
                i += 1
                continue
        else:
            i += 1
            continue

    return None, None

found = False
m = 16
p, q = 0, 0
for ra in range(1010, 1016):
    print(f"at ra={ra}") 
    for rb in range(1315, 1321):
        print(f"at rb={rb}") 
        p, q = factor_via_algorithm(N, ra, rb, m)
        if p and q:
            found = True
            break
    if found:
        break

if not found:
    print("fail")
    exit(1)

phi = (p-1)*(q-1)
d = pow(int(e), -1, int(phi))
m = pow(int(c), int(d), int(N))

pt = ZZ(m).to_bytes((ZZ(m).nbits()+7)//8, 'big')
try:
    print(pt.decode())
except Exception:
    print(pt.hex())
```

# Challenge description

Name: `With great powers comes great responsability`

Description:
```
Some wise person once said "with great power comes great responsability". See if you can use your big powers to crack this one and recover the flag.
```

Output with more prints:
```
N = 681394780999866190754659213123044717191715802643250708626809320838658778281144593727739663209837045355995308421413942828514152818648977873331104105081516452731800472325836611779314818462243193426099023496541746425007897604260151865971382334573678159185236454545626597908840746093045971828762474777264361457955742301124914308817172222724904673662370155602109259829569214773320574391778663341473530817577757208567569217179499401601819814059135668317316486810860796513686364156076445602008131732866040545046905275113589058718772631135615671995571949598884279533991843760477188394490194661695211918956119252397613791660662786638355440627365801169939573638066199940297947011255546242278159925314216283426330130357017097669042049401560818361006121158551800594245771687561997457507996473064827678925407234466681829883216945008610190906166966671484929431907603318173185118690723356055852743648251196391861556170411865924607659462219924254880433507916185443528766788839916434005473516259899808211380528891901570026087255071960852088469607478882639920289227459708783304155068215963885816028437091388019124889893940103059466112671620816380233612284989568840512084173935363114174196347989885994578950712852340332187131129751064242447872289
c = 42812930977524388513467562381107665457183388179636833486233298730856495507811454372446817014742478391753520100955900662459440703250225912163667412234230775948596810879200171037918862486053895636221232174786574190495217421100347415667882255496851995994695491088407437761854050557569735344397955049370600967236505786065690814196706045553475040729490360627571218433857809780258536268867273856941268352549971044327276794642397894590386970406674745468703436828305366428115493442636651259651285006514360923051001535102411311724083832635270403587675731040211836579605525772366137880862174700376474667107710764260252619650415358916289186247552886970262957279613209341156545305894050225570647662268359552920453354322430337770926296883749970372606744758064847265556586272075949309988217520649401232406289505004905379321221026461011286211685830451863238237168823938290390724239244714746192656154662454445221786726747276537045701380922973056489425141619977400519472770363724019322774287259895354759692851921617742024273320139201682823625006695203900063086423792385111412451649160021208097073639113907258231413500099172566638471762083423570648556289456872193692404267834356235516359256634399940815612978430415246658154399380930510570722036
r_a = 1015
r_b = 1318
m = 16
```

Provided output:
```
N = 681394780999866190754659213123044717191715802643250708626809320838658778281144593727739663209837045355995308421413942828514152818648977873331104105081516452731800472325836611779314818462243193426099023496541746425007897604260151865971382334573678159185236454545626597908840746093045971828762474777264361457955742301124914308817172222724904673662370155602109259829569214773320574391778663341473530817577757208567569217179499401601819814059135668317316486810860796513686364156076445602008131732866040545046905275113589058718772631135615671995571949598884279533991843760477188394490194661695211918956119252397613791660662786638355440627365801169939573638066199940297947011255546242278159925314216283426330130357017097669042049401560818361006121158551800594245771687561997457507996473064827678925407234466681829883216945008610190906166966671484929431907603318173185118690723356055852743648251196391861556170411865924607659462219924254880433507916185443528766788839916434005473516259899808211380528891901570026087255071960852088469607478882639920289227459708783304155068215963885816028437091388019124889893940103059466112671620816380233612284989568840512084173935363114174196347989885994578950712852340332187131129751064242447872289
c = 42812930977524388513467562381107665457183388179636833486233298730856495507811454372446817014742478391753520100955900662459440703250225912163667412234230775948596810879200171037918862486053895636221232174786574190495217421100347415667882255496851995994695491088407437761854050557569735344397955049370600967236505786065690814196706045553475040729490360627571218433857809780258536268867273856941268352549971044327276794642397894590386970406674745468703436828305366428115493442636651259651285006514360923051001535102411311724083832635270403587675731040211836579605525772366137880862174700376474667107710764260252619650415358916289186247552886970262957279613209341156545305894050225570647662268359552920453354322430337770926296883749970372606744758064847265556586272075949309988217520649401232406289505004905379321221026461011286211685830451863238237168823938290390724239244714746192656154662454445221786726747276537045701380922973056489425141619977400519472770363724019322774287259895354759692851921617742024273320139201682823625006695203900063086423792385111412451649160021208097073639113907258231413500099172566638471762083423570648556289456872193692404267834356235516359256634399940815612978430415246658154399380930510570722036
```

Flag: `ISMCTF{R3v3rS1nG+C7yPT0=l0V3}`
Points: `45`
Difficulty: `Hard`
Category: `Reverse Engineering, Cryptography`
Hint 1 - 10 points: `The binary has been obfuscated using Garble. Feel free to deobufscate some of the strings and look for flag related strings to guide you towards the right path, it is quite short (the binary) otherwise.`
Hint 2 - 14 points: `The binary uses RSA to encrypt a flag. Check out how the RSA primes are generated and search for ways you can attack that to factor N.`
Hint 3 - 19 points: `http://psasir.upm.edu.my/id/eprint/76375/1/8.pdf`